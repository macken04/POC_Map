{{ 'design-system.css' | asset_url | stylesheet_tag }}
{{ 'map-design.css' | asset_url | stylesheet_tag }}

<!-- Include Mapbox GL JS CDN -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

<!-- Include authentication utilities -->
{{ 'auth-utils.js' | asset_url | script_tag }}

<!-- Include existing Mapbox integration assets -->
{{ 'mapbox-config.js' | asset_url | script_tag }}
{{ 'canvas-size-manager.js' | asset_url | script_tag }}
<!-- mapbox-integration.js already loaded in theme.liquid layout -->

<!-- Modern Full-Page Poster Designer Container -->
<div class="poster-designer-container">
  <!-- Navigation Bar -->
  <div class="poster-nav-bar">
    <div class="nav-brand">
      <div class="brand-logo">S</div>
      <div class="nav-links">
        <a href="/pages/strava-activities" class="nav-link">My Activities</a>
        <span class="nav-link active">›</span>
        <span class="nav-link active">Design Your Map</span>
      </div>
    </div>
    <div class="nav-actions">
      <button class="action-btn" id="save-button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17,21 17,13 7,13 7,21"/>
          <polyline points="7,3 7,8 15,8"/>
        </svg>
        Save
      </button>
      <button class="action-btn" id="share-button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
          <polyline points="16,6 12,2 8,6"/>
          <line x1="12" y1="2" x2="12" y2="15"/>
        </svg>
        Share
      </button>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="poster-designer-layout">
    <!-- Left Sidebar -->
    <div class="poster-sidebar">
      <!-- Selected Route Card -->
      <div class="selected-route-card">
        <div class="route-indicator">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          Selected Route
        </div>
        <div class="route-name" id="route-name">Morning Mountain Climb</div>
        <div class="route-location" id="route-location">Boulder, Colorado</div>
        <div class="route-stats">
          <span class="route-stat" id="route-distance">53.3km</span>
          <span class="stat-separator">—</span>
          <span class="route-stat" id="route-elevation">743m</span>
          <span class="stat-separator">•</span>
          <span class="route-stat" id="route-date">January 15, 2024</span>
        </div>
      </div>

      <!-- Step Progress Section -->
      <div class="step-progress-section">
        <h2 class="section-title">Customize Your Poster</h2>
        
        <div class="step-indicators">
          <div class="step-item active" data-step="style">
            <div class="step-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"/>
              </svg>
            </div>
            <div class="step-content">
              <div class="step-label">Style</div>
              <div class="step-description">Pick colors and visual style</div>
            </div>
          </div>
          
          <div class="step-item" data-step="text">
            <div class="step-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4,7 4,4 20,4 20,7"/>
                <line x1="9" y1="20" x2="15" y2="20"/>
                <line x1="12" y1="4" x2="12" y2="20"/>
              </svg>
            </div>
            <div class="step-content">
              <div class="step-label">Text</div>
              <div class="step-description">Add titles and customize text</div>
            </div>
          </div>
          
          <div class="step-item" data-step="layout">
            <div class="step-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
              </svg>
            </div>
            <div class="step-content">
              <div class="step-label">Layout</div>
              <div class="step-description">Choose size and orientation</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Content Area -->
      <div class="step-content-area">
        <!-- Style Step Panel -->
        <div class="step-panel active" id="style-step">
          <h3 class="panel-title">Choose Your Style</h3>
          
          <!-- Two-Tier Style Selector -->
          <div class="style-selector-wrapper">
            <!-- Map Type Selection (First Tier) -->
            <div class="map-type-section">
              <label class="selector-label">Map Type</label>
              <div class="map-type-grid" id="theme-color-selector">
                <!-- JavaScript will populate this with map type options -->
                <div class="text-center" style="padding: 1rem; color: var(--poster-text-muted); grid-column: 1 / -1;">
                  <div class="loading-spinner" style="margin: 0 auto 0.5rem;"></div>
                  <p style="font-size: 0.875rem;">Loading options...</p>
                </div>
              </div>
            </div>
            
            <!-- Map Style Selection (Second Tier) -->
            <div class="map-style-section">
              <label class="selector-label">Color Style</label>
              <div class="map-style-grid" id="map-style-options">
                <!-- JavaScript will populate this with style options based on selected type -->
              </div>
            </div>
          </div>
          
          <!-- Route Thickness -->
          <div class="route-thickness-section">
            <h4 class="control-title">Route Line Width</h4>
            <div class="thickness-control">
              <input type="range" id="route-thickness-slider" class="thickness-slider" min="1" max="10" value="4">
              <div class="thickness-labels">
                <span>Thin</span>
                <span>Thick</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Text Step Panel -->
        <div class="step-panel" id="text-step">
          <h3 class="panel-title">Add Your Text</h3>
          
          <div class="text-inputs">
            <div class="input-group">
              <label class="input-label" for="main-title-input">Main Title</label>
              <input type="text" id="main-title-input" class="text-input" placeholder="Enter main title" value="EPIC RIDE">
              <div class="input-help">This will be the main heading on your poster</div>
            </div>
            
            <div class="input-group">
              <label class="input-label" for="subtitle-input">Subtitle</label>
              <input type="text" id="subtitle-input" class="text-input" placeholder="Enter subtitle" value="Summer 2023">
              <div class="input-help">Optional subtitle or date</div>
            </div>
          </div>
          
          <div class="text-suggestions">
            <h4 class="control-title">Quick Suggestions</h4>
            <div class="suggestion-list">
              <button class="suggestion-item" data-field="title" data-value="EPIC RIDE">Epic Ride</button>
              <button class="suggestion-item" data-field="title" data-value="ADVENTURE AWAITS">Adventure Awaits</button>
              <button class="suggestion-item" data-field="subtitle" data-value="Summer 2023">Summer 2023</button>
              <button class="suggestion-item" data-field="subtitle" data-value="Mountain Adventure">Mountain Adventure</button>
            </div>
          </div>
          
          <div class="stats-preview">
            <h4 class="control-title">Route Stats Preview</h4>
            <div class="stats-badge" id="overlay-distance">53.3km — 743m</div>
            <div class="stats-help">Distance and elevation will be automatically added</div>
          </div>
        </div>

        <!-- Layout Step Panel -->
        <div class="step-panel" id="layout-step">
          <h3 class="panel-title">Choose Size & Layout</h3>
          
          <div class="layout-options">
            <div class="layout-option active" data-layout="portrait">
              <div class="layout-preview portrait-preview"></div>
              <div class="layout-info">
                <div class="layout-name">Portrait</div>
                <div class="layout-description">Tall format</div>
              </div>
            </div>
            
            <div class="layout-option" data-layout="landscape">
              <div class="layout-preview landscape-preview"></div>
              <div class="layout-info">
                <div class="layout-name">Landscape</div>
                <div class="layout-description">Wide format</div>
              </div>
            </div>
          </div>
          
          <div class="print-sizes">
            <h4 class="control-title">Print Size</h4>
            <div class="size-grid">
              <div class="size-option" data-size="a4">
                <div class="size-name">A4</div>
                <div class="size-dimensions">21.0 x 29.7 cm</div>
                <div class="size-price">£45</div>
              </div>
              
              <div class="size-option active popular" data-size="a3">
                <div class="size-badge">POPULAR</div>
                <div class="size-name">A3</div>
                <div class="size-dimensions">29.7 x 42.0 cm</div>
                <div class="size-price">£55</div>
              </div>
              
              <div class="size-option" data-size="a2">
                <div class="size-name">A2</div>
                <div class="size-dimensions">42.0 x 59.4 cm</div>
                <div class="size-price">£65</div>
              </div>
              
              <div class="size-option" data-size="a1">
                <div class="size-name">A1</div>
                <div class="size-dimensions">59.4 x 84.1 cm</div>
                <div class="size-price">£75</div>
              </div>
            </div>
          </div>
          
          <div class="whats-included">
            <h4 class="control-title" style="margin-bottom: 0.75rem;">What's Included</h4>
            <ul class="included-list">
              <li>• High-quality 300 DPI print</li>
              <li>• Premium matte paper</li>
              <li>• Protective packaging</li>
              <li>• Free worldwide shipping</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Navigation Footer -->
      <div class="navigation-footer">
        <div class="pricing-info">
          <span class="current-price">£55<span class="size-info">(A3 Portrait)</span></span>
        </div>
        
        <div class="step-indicator">
          Step <span id="current-step-number">1</span> of 3
        </div>
        
        <div class="navigation-buttons">
          <button class="nav-btn nav-btn--secondary" id="prev-step-btn" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15,18 9,12 15,6"/>
            </svg>
            Previous
          </button>
          
          <button class="nav-btn nav-btn--primary" id="next-step-btn">
            Next
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9,18 15,12 9,6"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Preview Area -->
    <div class="poster-preview-area">
      <div class="map-display-wrapper">
        <!-- Map Container -->
        <div id="mapbox-map" class="mapbox-map-container">
          <!-- Map will be rendered here by MapboxIntegration -->
        </div>
        
        <!-- Text Overlays -->
        <div class="text-overlays">
          <div class="title-overlay" id="main-title-overlay">EPIC RIDE</div>
          <div class="subtitle-overlay" id="subtitle-overlay">Summer 2023</div>
          <div class="stats-overlay" id="stats-overlay">
            <span id="overlay-distance">53.3km</span> — <span id="overlay-elevation">743m</span>
          </div>
        </div>
        
        <!-- Map Loading State -->
        <div class="map-loading-overlay" id="map-loading">
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <h4 style="margin-bottom: 0.5rem;">Loading your custom map...</h4>
            <p style="color: var(--poster-text-muted);">Please wait while we prepare your route visualization.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error State (Global Overlay) -->
<div class="error-overlay hidden" id="map-error">
  <div class="error-content">
    <div class="error-icon">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <circle cx="12" cy="16" r="1" fill="currentColor"/>
      </svg>
    </div>
    <h4 id="error-title" style="margin-bottom: 0.5rem;">Unable to Load Map</h4>
    <p id="error-message" style="margin-bottom: 1.5rem; color: var(--poster-text-muted);">There was an issue loading your activity data.</p>
    <div class="error-actions">
      <button type="button" class="nav-btn nav-btn--secondary" id="retry-map-button">
        Try Again
      </button>
      <a href="/pages/strava-activities" class="nav-btn nav-btn--primary">
        Back to Activities
      </a>
    </div>
  </div>
</div>

<!-- Create Poster Button (Legacy compatibility) -->
<button class="hidden" id="create-poster-btn">Create My Poster</button>

{{ 'map-design.js' | asset_url | script_tag }}

<script>
  // Utility function to wait for dependencies to be available
  async function waitForDependencies(dependencies, timeoutMs = 10000) {
    const startTime = Date.now();
    const checkInterval = 100; // Check every 100ms
    
    while (Date.now() - startTime < timeoutMs) {
      const missingDeps = dependencies.filter(dep => {
        try {
          return typeof window[dep] === 'undefined';
        } catch (e) {
          return true;
        }
      });
      
      if (missingDeps.length === 0) {
        console.log('All dependencies loaded:', dependencies);
        return; // All dependencies are available
      }
      
      console.log('Still waiting for dependencies:', missingDeps);
      await new Promise(resolve => setTimeout(resolve, checkInterval));
    }
    
    // Check one final time and throw detailed error if still missing
    const stillMissing = dependencies.filter(dep => typeof window[dep] === 'undefined');
    if (stillMissing.length > 0) {
      throw new Error(`Timeout waiting for dependencies: ${stillMissing.join(', ')}. Check that all script files are loading correctly.`);
    }
  }

  // Enhanced initialization with dependency waiting and robust error handling
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('Modern Map Design page: DOM loaded, beginning initialization...');
    
    // Show loading state
    const mapLoading = document.getElementById('map-loading');
    const mapError = document.getElementById('map-error');
    
    if (mapLoading) {
      mapLoading.style.display = 'flex';
    }
    
    try {
      await initializeMapDesign();
      
    } catch (error) {
      console.error('Modern Map Design initialization failed:', error);
      showError(error);
      
      // Log additional debug information
      console.group('Map Design Debug Information');
      console.log('MapDesign available:', typeof MapDesign !== 'undefined');
      console.log('MapboxConfig available:', typeof MapboxConfig !== 'undefined');
      console.log('MapboxIntegration available:', typeof MapboxIntegration !== 'undefined');
      console.log('Mapbox GL JS available:', typeof mapboxgl !== 'undefined');
      console.log('Error details:', error);
      console.groupEnd();
    }
  });
  
  // Enhanced retry mechanism with progressive backoff
  let retryCount = 0;
  const maxRetries = 3;
  
  async function retryInitialization() {
    retryCount++;
    console.log(`Retrying map initialization (attempt ${retryCount}/${maxRetries})...`);
    
    if (retryCount >= maxRetries) {
      console.error('Maximum retry attempts reached. Please refresh the page manually.');
      const errorMessage = document.getElementById('error-message');
      if (errorMessage) {
        errorMessage.textContent = 'Maximum retry attempts reached. Please refresh the page to try again.';
      }
      return;
    }
    
    // Clear previous instance if it exists
    if (window.mapDesignInstance) {
      try {
        await window.mapDesignInstance.destroy();
      } catch (e) {
        console.warn('Error destroying previous instance:', e);
      }
      window.mapDesignInstance = null;
    }
    
    // Progressive backoff delay
    const delay = Math.min(1000 * Math.pow(2, retryCount - 1), 5000);
    console.log(`Waiting ${delay}ms before retry...`);
    
    setTimeout(async () => {
      try {
        // Show loading state again
        const mapLoading = document.getElementById('map-loading');
        const mapError = document.getElementById('map-error');
        
        if (mapLoading) mapLoading.style.display = 'flex';
        if (mapError) mapError.classList.add('hidden');
        
        // Re-run the initialization logic
        await initializeMapDesign();
        
      } catch (error) {
        console.error(`Retry attempt ${retryCount} failed:`, error);
        showError(error);
      }
    }, delay);
  }
  
  // Extract initialization logic into separate function for reuse
  async function initializeMapDesign() {
    // Step 1: Wait for all dependencies to be available with timeout
    console.log('Modern Map Design: Waiting for dependencies...');
    await waitForDependencies(['MapDesign', 'MapboxConfig', 'MapboxIntegration', 'mapboxgl'], 10000);
    console.log('Modern Map Design: All dependencies loaded successfully');
    
    // Step 2: Initialize MapboxConfig first (async)
    console.log('Modern Map Design: Initializing MapboxConfig...');
    try {
      await MapboxConfig.init();
      console.log('Modern Map Design: MapboxConfig initialized successfully');
    } catch (configError) {
      console.warn('Modern Map Design: MapboxConfig initialization had issues:', configError.message);
      console.log('Modern Map Design: Continuing with degraded functionality...');
    }
    
    // Step 3: Create and initialize MapDesign instance
    console.log('Modern Map Design: Creating MapDesign instance...');
    window.mapDesignInstance = new MapDesign({
      showActivityInfo: {{ section.settings.show_activity_info | json }},
      showStyleControls: {{ section.settings.show_style_controls | json }},
      showExportOptions: {{ section.settings.show_export_options | json }},
      defaultMapStyle: '{{ section.settings.default_map_style | default: "grey" }}',
      defaultExportFormat: '{{ section.settings.default_export_format | default: "A4" }}'
    });
    
    // Step 4: Initialize MapDesign (async)
    console.log('Modern Map Design: Initializing MapDesign...');
    await window.mapDesignInstance.init();
    console.log('Modern Map Design: Map Design initialized successfully');
    
    // Hide loading state on success
    const mapLoading = document.getElementById('map-loading');
    if (mapLoading) {
      mapLoading.style.display = 'none';
    }
    
    // Reset retry count on successful initialization
    retryCount = 0;
  }
  
  // Function to show error state with appropriate messaging
  function showError(error) {
    const mapLoading = document.getElementById('map-loading');
    const mapError = document.getElementById('map-error');
    const errorTitle = document.getElementById('error-title');
    const errorMessage = document.getElementById('error-message');
    
    // Hide loading state
    if (mapLoading) {
      mapLoading.style.display = 'none';
    }
    
    // Show error state with details
    if (mapError) {
      mapError.classList.remove('hidden');
      
      if (errorTitle) {
        errorTitle.textContent = 'Map Initialization Failed';
      }
      
      if (errorMessage) {
        if (retryCount < maxRetries) {
          errorMessage.textContent = `${error.message} (Attempt ${retryCount}/${maxRetries})`;
        } else {
          errorMessage.textContent = error.message;
        }
      }
    }
  }
  
  // Bind retry button if it exists
  document.addEventListener('DOMContentLoaded', function() {
    const retryButton = document.getElementById('retry-map-button');
    if (retryButton) {
      retryButton.addEventListener('click', retryInitialization);
    }
  });
</script>

{% schema %}
{
  "name": "Map Design",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Design Your Custom Map",
      "label": "Heading"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Customize your route map with different styles, colors, and export options.",
      "label": "Description"
    },
    {
      "type": "checkbox",
      "id": "show_activity_info",
      "default": true,
      "label": "Show activity information"
    },
    {
      "type": "checkbox",
      "id": "show_style_controls",
      "default": true,
      "label": "Show style controls"
    },
    {
      "type": "select",
      "id": "default_map_style",
      "options": [
        {
          "value": "streets",
          "label": "Streets"
        },
        {
          "value": "outdoors",
          "label": "Outdoors"
        },
        {
          "value": "light",
          "label": "Light"
        },
        {
          "value": "dark",
          "label": "Dark"
        },
        {
          "value": "satellite",
          "label": "Satellite"
        }
      ],
      "default": "outdoors",
      "label": "Default map style"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "Map Design"
    }
  ]
}
{% endschema %}