{{ 'design-system-variables.css' | asset_url | stylesheet_tag }}
{{ 'design-system.css' | asset_url | stylesheet_tag }}
{{ 'strava-cards-v3.css' | asset_url | append: '?v=' | append: 'now' | stylesheet_tag }}

<!-- Include authentication utilities -->
{{ 'auth-utils.js' | asset_url | script_tag }}

<div class="strava-activities-section">
  <div class="strava-content-wrapper">
    <!-- User connection status -->
    <div id="user-connection-status" class="user-connection-status hidden">
      <svg class="user-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <span id="connection-text">Connected as <strong id="user-name">Loading...</strong></span>
    </div>

    {%- comment -%}
    Section Header removed per user request
    {%- if section.settings.heading != blank or section.settings.description != blank -%}
    <div class="section-header">
      {%- if section.settings.heading != blank -%}
        <h2 class="section-heading">{{ section.settings.heading }}</h2>
      {%- endif -%}
      {%- if section.settings.description != blank -%}
        <p class="section-description">{{ section.settings.description }}</p>
      {%- endif -%}
    </div>
    {%- endif -%}
    {%- endcomment -%}

    <!-- Statistics Dashboard -->
    <div class="statistics-dashboard">
      <div class="stat-card stat-activities">
        <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
        </svg>
        <div class="stat-number" id="total-activities">0</div>
        <div class="stat-label">Total Activities</div>
      </div>
      <div class="stat-card stat-distance">
        <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498l4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 00-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0z" />
        </svg>
        <div class="stat-number" id="total-distance">0</div>
        <div class="stat-label">Total Distance (km)</div>
      </div>
      <div class="stat-card stat-elevation">
        <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
        </svg>
        <div class="stat-number" id="total-elevation">0</div>
        <div class="stat-label">Total Elevation (m)</div>
      </div>
      <div class="stat-card stat-time">
        <svg class="stat-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div class="stat-number" id="total-time">0h 0m</div>
        <div class="stat-label">Total Time</div>
      </div>
    </div>

    <!-- Enhanced Controls Section -->
    {%- if section.settings.show_search or section.settings.show_filters -%}
    <div class="strava-activities-controls">
      <div class="controls-header">
        <div id="auth-status" class="auth-status-container hidden">
          <div class="auth-status-message">
            <svg class="auth-status-icon" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span id="auth-status-text">Checking authentication...</span>
          </div>
        </div>
      </div>
      
      <div class="controls-body">
        {%- if section.settings.show_search -%}
        <div class="strava-activities-search" role="search">
          <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input
            type="text"
            id="activity-search"
            class="strava-search-input"
            placeholder="Search activities..."
            autocomplete="off"
            aria-label="Search activities by name"
          >
          <button type="button" class="search-clear-button hidden" id="search-clear" aria-label="Clear search">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </button>
          <span class="search-keyboard-hint" id="search-keyboard-hint" aria-hidden="true">
            <kbd id="shortcut-key"></kbd>
          </span>
        </div>
        {%- endif -%}
        
        {%- if section.settings.show_filters -%}
        <div class="strava-activities-filters" role="group" aria-label="Activity filters">
          <button type="button" class="filter-button" id="filter-activity-type" aria-label="Filter by activity type" aria-haspopup="true" aria-expanded="false">
            <svg class="filter-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            <span>Filter</span>
            <svg class="chevron-icon" width="16" height="16" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </button>

          <button type="button" class="filter-button" id="date-range-button" aria-label="Filter by date range">
            <svg class="calendar-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span>Date Range</span>
          </button>

          <button type="button" class="filter-button" id="sort-button" aria-label="Sort activities" aria-haspopup="true" aria-expanded="false">
            <svg class="sort-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>
            </svg>
            <span>Sort</span>
            <svg class="chevron-icon" width="16" height="16" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </button>

          <button type="button" class="filter-button selection-mode-toggle" id="selection-mode-toggle" aria-label="Enable selection mode to select multiple activities" aria-pressed="false">
            <svg class="selection-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            <span class="selection-mode-text">Select Multiple</span>
            <span class="selection-mode-count hidden">(<span id="selection-count">0</span> selected)</span>
          </button>

          <select id="activity-type-filter" class="strava-filter-select" aria-label="Select activity type">
            <option value="">All Activities</option>
            <option value="Ride">Cycling</option>
            <option value="Run">Running</option>
            <option value="Hike">Hiking</option>
            <option value="Walk">Walking</option>
          </select>

          <select id="sort-select" class="strava-filter-select" aria-label="Sort activities by">
            <option value="start_date_desc">Newest First</option>
            <option value="start_date_asc">Oldest First</option>
            <option value="distance_desc">Longest Distance</option>
            <option value="distance_asc">Shortest Distance</option>
            <option value="moving_time_desc">Longest Duration</option>
            <option value="moving_time_asc">Shortest Duration</option>
            <option value="total_elevation_gain_desc">Most Elevation</option>
            <option value="total_elevation_gain_asc">Least Elevation</option>
          </select>
        </div>
        {%- endif -%}
      </div>
    </div>
    {%- endif -%}

    <!-- Search Results Summary -->
    <div id="search-results-summary" class="search-results-summary hidden" role="status" aria-live="polite">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <span id="results-count-text">0 activities found</span>
    </div>

    <!-- Active Filter Badges -->
    <div id="active-filters-container" class="active-filters-container hidden" role="region" aria-label="Active filters">
      <div class="active-filters-label">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
        </svg>
        <span>Active filters:</span>
      </div>
      <div id="active-filter-badges" class="active-filter-badges"></div>
      <button type="button" id="clear-all-filters-btn" class="clear-all-filters-btn" aria-label="Clear all filters">
        Clear all
      </button>
    </div>

    <!-- Bulk Actions Toolbar -->
    <div id="bulk-actions-toolbar" class="bulk-actions-toolbar hidden" role="toolbar" aria-label="Bulk actions">
      <div class="bulk-actions-content">
        <div class="bulk-actions-info">
          <span id="bulk-selected-count">0</span> activities selected
        </div>
        <div class="bulk-actions-buttons">
          <button type="button" class="bulk-action-btn" id="bulk-create-posters" aria-label="Create posters for selected activities">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>Create Posters</span>
          </button>
          <button type="button" class="bulk-action-btn" id="bulk-export-data" aria-label="Export selected activities data">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>Export Data</span>
          </button>
          <button type="button" class="bulk-action-btn secondary" id="bulk-deselect-all" aria-label="Deselect all activities">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <span>Clear Selection</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="activities-loading" class="activities-loading hidden" role="status" aria-live="polite">
      <div class="loading-spinner" aria-hidden="true">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </div>
      <h3>Loading your activities...</h3>
      <p>Fetching your latest adventures from Strava</p>
    </div>

    <!-- Error State -->
    <div id="activities-error" class="activities-error hidden" role="alert" aria-live="assertive">
      <div class="error-icon" aria-hidden="true">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.865-.833-2.635 0L4.179 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      </div>
      <h3 id="error-title">Unable to load activities</h3>
      <p id="error-message">Please check your connection and try again.</p>
      <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
        <button type="button" id="retry-button" class="load-more-button" aria-label="Retry loading activities">Try Again</button>
        <a href="https://boss-hog-freely.ngrok-free.app/auth/strava" class="create-poster-button" style="min-width: auto; padding: 0.75rem 1.5rem;" aria-label="Connect your Strava account">Connect with Strava</a>
      </div>
    </div>

    <!-- Skeleton Loading Header -->
    <div id="skeleton-loading-header" class="skeleton-loading-header hidden" role="status" aria-live="polite">
      <div class="skeleton-loading-content">
        <div class="skeleton-loading-spinner"></div>
        <span class="skeleton-loading-text">Loading your activities...</span>
      </div>
    </div>

    <!-- Activities Grid -->
    <div class="activities-grid-wrapper">
      <div id="activities-grid" class="activities-grid hidden" role="list" aria-label="Strava activities">
        <!-- Activities will be populated by JavaScript -->
      </div>
      <!-- Infinite scroll trigger -->
      <div id="infinite-scroll-trigger" class="infinite-scroll-trigger" aria-hidden="true"></div>
    </div>

    <!-- Empty State - Enhanced -->
    <div id="activities-empty" class="activities-empty hidden" role="status" aria-live="polite">
      <div class="empty-state-content">
        <div class="empty-icon-wrapper" aria-hidden="true">
          <div class="empty-icon-background"></div>
          <svg id="empty-icon-svg" class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path id="empty-icon-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>

        <div class="empty-text-content">
          <h3 id="empty-title" class="empty-title">No activities found</h3>
          <p id="empty-description" class="empty-description">Try refreshing or <a href="https://www.strava.com" target="_blank" rel="noopener">upload some activities to Strava</a> to get started.</p>
        </div>

        <div id="empty-active-filters" class="empty-active-filters hidden">
          <p class="filter-label">Active filters:</p>
          <div id="empty-filter-tags" class="empty-filter-tags"></div>
        </div>

        <div id="empty-actions" class="empty-actions">
          <button type="button" id="empty-clear-filters" class="strava-btn strava-btn-secondary hidden" aria-label="Clear all filters">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Clear Filters
          </button>
          <a href="https://www.strava.com" target="_blank" rel="noopener" class="strava-btn strava-btn-primary" aria-label="Go to Strava to upload activities">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
              <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"></path>
            </svg>
            Go to Strava
        </a>
      </div>
    </div>

    <!-- Load More Section -->
    <div id="activities-pagination" class="load-more-section hidden">
      <div class="activities-pagination">
        <p class="pagination-info">
          <span id="activities-count">0</span> activities loaded <span id="pagination-status"></span>
        </p>
        <button type="button" id="load-more-btn" class="load-more-button">
          <span id="load-more-text">Load More Activities</span>
          <!-- Arrow icon (default) -->
          <svg id="load-more-arrow" class="load-more-icon" width="16" height="16" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
          <!-- Loading spinner (hidden by default) -->
          <svg id="load-more-spinner" class="load-more-icon spinner hidden" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

{{ 'strava-activities.js' | asset_url | script_tag }}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof StravaActivities !== 'undefined') {
      const activitiesManager = new StravaActivities({
        activitiesPerPage: {{ section.settings.activities_per_page | default: 12 }}
      });
      activitiesManager.init();
    } else {
      console.error('StravaActivities not loaded');
      document.getElementById('activities-error').classList.remove('hidden');
      document.getElementById('error-title').textContent = 'Script Loading Error';
      document.getElementById('error-message').textContent = 'Failed to load activities functionality.';
    }
  });
</script>

{% schema %}
{
  "name": "Strava Activities",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Your Strava Activities",
      "label": "Heading"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Select an activity to create a personalized map of your ride.",
      "label": "Description"
    },
    {
      "type": "number",
      "id": "activities_per_page",
      "default": 12,
      "label": "Activities per page",
      "info": "Number of activities to display per page (maximum 30)"
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "default": true,
      "label": "Show search"
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "default": true,
      "label": "Show filters"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "Strava Activities"
    }
  ]
}
{% endschema %}