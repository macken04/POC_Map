{{ 'design-system-variables.css' | asset_url | stylesheet_tag }}
{{ 'strava-pages.css' | asset_url | stylesheet_tag }}
{{ 'strava-integration.js' | asset_url | script_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="page-width section-{{ section.id }}-padding">
  <div class="activity-selector-container">
    <!-- Header Section -->
    <div class="activity-selector-header">
      {% if section.settings.heading != blank %}
        <h1 class="strava-page-heading">{{ section.settings.heading | escape }}</h1>
      {% endif %}

      {% if section.settings.description != blank %}
        <p class="strava-page-description">{{ section.settings.description | escape }}</p>
      {% endif %}

      <!-- User Info Bar -->
      <div class="user-info-bar" id="user-info-bar" style="display: none;">
        <div class="user-info-left">
          <div class="user-avatar-small" id="user-avatar-small">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 7C13.89 7 13 7.89 13 9V15L11 15V9C11 8.45 11.45 8 12 8V7C10.34 7 9 8.34 9 10V15L7 15V9H5V15C5 16.1 5.9 17 7 17H17C18.1 17 19 16.1 19 15V9H21ZM7 19H17V21H7V19Z"/>
            </svg>
          </div>
          <span>Welcome back, <strong id="user-name-display">Athlete</strong>!</span>
        </div>
        <div class="user-info-right">
          <button type="button" class="strava-btn strava-btn-link" id="logout-btn">
            <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
              <path d="M17,7L15.59,8.41L18.17,11H8V13H18.17L15.59,15.59L17,17L22,12L17,7M4,5H12V3H4C2.89,3 2,3.89 2,5V19C2,20.11 2.89,21 4,21H12V19H4V5Z"/>
            </svg>
            Disconnect
          </button>
        </div>
      </div>
    </div>

    <!-- Filter and Search Controls -->
    <div class="activity-controls">
      <div class="search-control">
        <input type="text" id="activity-search" placeholder="Search activities..." class="activity-search-input">
        <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
        </svg>
      </div>

      <div class="filter-controls">
        <select id="activity-type-filter" class="activity-filter-select">
          <option value="">All Activities</option>
          <option value="Ride">Cycling</option>
          <option value="Run">Running</option>
          <option value="Walk">Walking</option>
          <option value="Hike">Hiking</option>
        </select>

        <select id="date-range-filter" class="activity-filter-select">
          <option value="">All Time</option>
          <option value="7">Last Week</option>
          <option value="30">Last Month</option>
          <option value="90">Last 3 Months</option>
          <option value="365">Last Year</option>
        </select>

        <button type="button" class="strava-btn strava-btn-secondary" id="clear-filters-btn">
          Clear Filters
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="activities-loading" id="activities-loading">
      <div class="loading-content">
        <div class="loading-spinner-large"></div>
        <h4>Loading Your Activities...</h4>
        <p>Fetching your latest rides from Strava.</p>
      </div>
    </div>

    <!-- Activities Grid -->
    <div class="activities-grid" id="activities-grid" style="display: none;">
      <!-- Activity cards will be populated here by JavaScript -->
    </div>

    <!-- Empty State -->
    <div class="activities-empty" id="activities-empty" style="display: none;">
      <div class="empty-state-icon">
        <svg viewBox="0 0 24 24" width="60" height="60" fill="currentColor">
          <path d="M5,13.18V11.18L12,17.18L19,11.18V13.18L12,19.18L5,13.18Z"/>
        </svg>
      </div>
      <h3>No Activities Found</h3>
      <p>We couldn't find any activities matching your criteria.</p>
      <button type="button" class="strava-btn strava-btn-secondary" onclick="window.location.reload()">
        Refresh Activities
      </button>
    </div>

    <!-- Error State -->
    <div class="activities-error" id="activities-error" style="display: none;">
      <div class="error-content">
        <div class="error-icon">⚠️</div>
        <h4>Unable to Load Activities</h4>
        <p id="activities-error-message">There was an error loading your Strava activities.</p>
        <button type="button" class="strava-btn strava-btn-primary" id="retry-activities-btn">
          Try Again
        </button>
      </div>
    </div>

    <!-- Pagination -->
    <div class="activities-pagination" id="activities-pagination" style="display: none;">
      <div class="pagination-info">
        <span id="activities-count">0</span> activities loaded
        <span id="pagination-status" style="margin-left: 10px; color: #666;"></span>
      </div>
      <button type="button" class="strava-btn strava-btn-secondary" id="load-more-btn">
        Load More Activities
      </button>
    </div>

    <!-- Selection Info -->
    <div class="selection-info" id="selection-info" style="display: none;">
      <div class="selection-content">
        <h4>Activity Selected!</h4>
        <p id="selected-activity-name">Activity name will appear here</p>
        <div class="selection-actions">
          <button type="button" class="strava-btn strava-btn-success strava-btn-large" id="proceed-to-map-btn">
            <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path d="M9,0C4.03,0 0,4.03 0,9C0,14.25 9,24 9,24S18,14.25 18,9C18,4.03 13.97,0 9,0M9,11.5A2.5,2.5 0 0,1 6.5,9A2.5,2.5 0 0,1 9,6.5A2.5,2.5 0 0,1 11.5,9A2.5,2.5 0 0,1 9,11.5Z"/>
            </svg>
            Create Map Print
          </button>
          <button type="button" class="strava-btn strava-btn-link" id="clear-selection-btn">
            Choose Different Activity
          </button>
        </div>
      </div>
    </div>

    <!-- Progress Steps (bottom) -->
    <div class="strava-progress-steps">
      <div class="progress-step completed" id="step-connect">
        <div class="step-number">1</div>
        <div class="step-content">
          <div class="step-title">Connect</div>
          <div class="step-description">Strava account linked</div>
        </div>
      </div>
      <div class="progress-step active" id="step-activities">
        <div class="step-number">2</div>
        <div class="step-content">
          <div class="step-title">Activities</div>
          <div class="step-description">Choose your ride</div>
        </div>
      </div>
      <div class="progress-step" id="step-customize">
        <div class="step-number">3</div>
        <div class="step-content">
          <div class="step-title">Customize</div>
          <div class="step-description">Design your map</div>
        </div>
      </div>
      <div class="progress-step" id="step-order">
        <div class="step-number">4</div>
        <div class="step-content">
          <div class="step-title">Order</div>
          <div class="step-description">Get your print</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const activitySelector = new ActivitySelector({
    activitiesPerPage: {{ section.settings.activities_per_page | default: 12 }},
    showActivityStats: {{ section.settings.show_activity_stats | default: true }}
  });
  activitySelector.init();
});
</script>

{% schema %}
{
  "name": "Activity Selector",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Choose Your Ride",
      "label": "Heading"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Select from your recent Strava activities to create a personalized map print.",
      "label": "Description"
    },
    {
      "type": "range",
      "id": "activities_per_page",
      "min": 6,
      "max": 24,
      "step": 3,
      "label": "Activities Per Page",
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "show_activity_stats",
      "default": true,
      "label": "Show Activity Statistics"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "Activity Selector"
    }
  ]
}
{% endschema %}