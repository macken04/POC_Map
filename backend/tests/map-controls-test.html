<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Controls Test - Mapbox Integration</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #333;
            margin-top: 0;
        }
        
        .map-container {
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .control-test {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }
        
        .status {
            font-weight: bold;
            margin-left: 10px;
        }
        
        .pass { color: #10B981; }
        .fail { color: #EF4444; }
        .pending { color: #F59E0B; }
        
        .test-button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #2563EB;
        }
        
        .instructions {
            background: #E0F2FE;
            border: 1px solid #38BDF8;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .mobile-test {
            border: 2px dashed #F59E0B;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            background: #FEF3C7;
        }
        
        @media (max-width: 767px) {
            .mobile-test {
                border-color: #10B981;
                background: #D1FAE5;
            }
            
            .mobile-test::before {
                content: "üì± Mobile Mode Active - ";
                font-weight: bold;
                color: #10B981;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üó∫Ô∏è Map Controls Test Suite</h1>
            <p>Testing enhanced map controls and navigation functionality</p>
        </div>

        <!-- Test Section 1: Basic Map Controls -->
        <div class="test-section">
            <h2>1. Basic Map Controls Test</h2>
            <div class="instructions">
                <strong>Instructions:</strong> The map below should display with all standard controls visible and functional.
            </div>
            
            <div id="map1" class="map-container"></div>
            
            <div class="controls-grid">
                <div class="control-test">
                    <strong>Navigation Control:</strong>
                    <span id="nav-status" class="status pending">Testing...</span>
                </div>
                <div class="control-test">
                    <strong>Fullscreen Control:</strong>
                    <span id="fullscreen-status" class="status pending">Testing...</span>
                </div>
                <div class="control-test">
                    <strong>Scale Control:</strong>
                    <span id="scale-status" class="status pending">Testing...</span>
                </div>
                <div class="control-test">
                    <strong>Geolocation Control:</strong>
                    <span id="geo-status" class="status pending">Testing...</span>
                </div>
                <div class="control-test">
                    <strong>Style Switcher:</strong>
                    <span id="style-status" class="status pending">Testing...</span>
                </div>
                <div class="control-test">
                    <strong>Export Control:</strong>
                    <span id="export-status" class="status pending">Testing...</span>
                </div>
            </div>
        </div>

        <!-- Test Section 2: Keyboard Accessibility -->
        <div class="test-section">
            <h2>2. Keyboard Accessibility Test</h2>
            <div class="instructions">
                <strong>Instructions:</strong> Click on the map to focus it, then use keyboard shortcuts:
                <br>‚Ä¢ Arrow keys: Pan the map
                <br>‚Ä¢ +/- keys: Zoom in/out
                <br>‚Ä¢ R key: Reset north
                <br>‚Ä¢ Ctrl+F: Toggle fullscreen
            </div>
            
            <div id="map2" class="map-container"></div>
            
            <button class="test-button" onclick="testKeyboardControls()">Test Keyboard Navigation</button>
            <span id="keyboard-status" class="status pending">Click test button</span>
        </div>

        <!-- Test Section 3: Custom Positioning -->
        <div class="test-section">
            <h2>3. Custom Control Positioning</h2>
            <div class="instructions">
                <strong>Instructions:</strong> This map has custom control positioning - navigation on bottom-left, export on bottom-right.
            </div>
            
            <div id="map3" class="map-container"></div>
            
            <button class="test-button" onclick="testCustomPositioning()">Verify Custom Positions</button>
            <span id="position-status" class="status pending">Click test button</span>
        </div>

        <!-- Test Section 4: Mobile Optimization -->
        <div class="test-section">
            <h2>4. Mobile Optimization Test</h2>
            <div class="mobile-test">
                <strong>Mobile Test:</strong> Resize your browser window to under 768px width or use developer tools device emulation to test mobile optimization.
            </div>
            
            <div id="map4" class="map-container"></div>
            
            <button class="test-button" onclick="testMobileOptimization()">Test Mobile Features</button>
            <span id="mobile-status" class="status pending">Test mobile responsiveness</span>
        </div>

        <!-- Test Results Summary -->
        <div class="test-section">
            <h2>üìä Test Results Summary</h2>
            <div id="test-summary">
                <p>Tests are running... Please wait for all tests to complete.</p>
            </div>
        </div>
    </div>

    <!-- Load MapboxConfig first -->
    <script src="../../shopify-theme/dawn/assets/mapbox-config.js"></script>
    <!-- Load MapboxIntegration -->
    <script src="../../shopify-theme/dawn/assets/mapbox-integration.js"></script>

    <script>
        // Set mock access token for testing
        window.shopifyMapboxToken = 'pk.eyJ1IjoidGVzdC11c2VyIiwiYSI6ImNsZXhhbXBsZSJ9.example-token';
        
        let testResults = {};
        let mapInstances = [];

        // Initialize all test maps
        async function initializeTests() {
            try {
                console.log('üß™ Starting Map Controls Tests...');
                
                // Test 1: Basic controls
                const map1 = new MapboxIntegration('map1', {
                    enableExport: true,
                    enableGeolocation: true,
                    enableScale: true
                });
                mapInstances.push(map1);
                
                // Test 2: Keyboard accessibility
                const map2 = new MapboxIntegration('map2', {
                    showControls: true,
                    allowInteraction: true
                });
                mapInstances.push(map2);
                
                // Test 3: Custom positioning
                const map3 = new MapboxIntegration('map3', {
                    controlPositions: {
                        navigation: 'bottom-left',
                        fullscreen: 'bottom-left',
                        geolocation: 'bottom-right',
                        scale: 'top-left',
                        style: 'top-right',
                        export: 'bottom-right'
                    }
                });
                mapInstances.push(map3);
                
                // Test 4: Mobile optimization
                const map4 = new MapboxIntegration('map4', {
                    mobileOptimized: true,
                    enableScale: true,
                    enableGeolocation: true
                });
                mapInstances.push(map4);
                
                // Wait for maps to initialize
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Run automated tests
                await runAutomatedTests();
                
            } catch (error) {
                console.error('‚ùå Test initialization failed:', error);
                updateSummary();
            }
        }

        async function runAutomatedTests() {
            // Test navigation control presence
            testResults.navigation = document.querySelector('.mapboxgl-ctrl-zoom-in') ? 'pass' : 'fail';
            document.getElementById('nav-status').textContent = testResults.navigation === 'pass' ? '‚úÖ Present' : '‚ùå Missing';
            document.getElementById('nav-status').className = `status ${testResults.navigation}`;
            
            // Test fullscreen control
            testResults.fullscreen = document.querySelector('.mapboxgl-ctrl-fullscreen') ? 'pass' : 'fail';
            document.getElementById('fullscreen-status').textContent = testResults.fullscreen === 'pass' ? '‚úÖ Present' : '‚ùå Missing';
            document.getElementById('fullscreen-status').className = `status ${testResults.fullscreen}`;
            
            // Test scale control
            testResults.scale = document.querySelector('.mapboxgl-ctrl-scale') ? 'pass' : 'fail';
            document.getElementById('scale-status').textContent = testResults.scale === 'pass' ? '‚úÖ Present' : '‚ùå Missing';
            document.getElementById('scale-status').className = `status ${testResults.scale}`;
            
            // Test geolocation control
            testResults.geolocation = document.querySelector('.mapboxgl-ctrl-geolocate') ? 'pass' : 'fail';
            document.getElementById('geo-status').textContent = testResults.geolocation === 'pass' ? '‚úÖ Present' : '‚ùå Missing';
            document.getElementById('geo-status').className = `status ${testResults.geolocation}`;
            
            // Test style switcher
            testResults.style = document.querySelector('.mapbox-style-switcher') ? 'pass' : 'fail';
            document.getElementById('style-status').textContent = testResults.style === 'pass' ? '‚úÖ Present' : '‚ùå Missing';
            document.getElementById('style-status').className = `status ${testResults.style}`;
            
            // Test export control
            testResults.export = document.querySelector('.mapboxgl-ctrl-icon') ? 'pass' : 'fail';
            document.getElementById('export-status').textContent = testResults.export === 'pass' ? '‚úÖ Present' : '‚ùå Missing';
            document.getElementById('export-status').className = `status ${testResults.export}`;
            
            updateSummary();
        }

        function testKeyboardControls() {
            const map = mapInstances[1];
            if (map && map.map) {
                const container = map.map.getContainer();
                container.focus();
                
                // Simulate keyboard event
                const event = new KeyboardEvent('keydown', { key: 'ArrowUp' });
                container.dispatchEvent(event);
                
                testResults.keyboard = container.hasAttribute('tabindex') ? 'pass' : 'fail';
                document.getElementById('keyboard-status').textContent = testResults.keyboard === 'pass' ? '‚úÖ Accessible' : '‚ùå Not accessible';
                document.getElementById('keyboard-status').className = `status ${testResults.keyboard}`;
                
                updateSummary();
            }
        }

        function testCustomPositioning() {
            // Check if controls are positioned correctly
            const bottomControls = document.querySelectorAll('#map3 .mapboxgl-ctrl-bottom-left, #map3 .mapboxgl-ctrl-bottom-right');
            testResults.positioning = bottomControls.length > 0 ? 'pass' : 'fail';
            
            document.getElementById('position-status').textContent = testResults.positioning === 'pass' ? '‚úÖ Custom positions work' : '‚ùå Default positions only';
            document.getElementById('position-status').className = `status ${testResults.positioning}`;
            
            updateSummary();
        }

        function testMobileOptimization() {
            const isMobile = window.innerWidth < 768;
            const touchFriendly = document.querySelector('[style*="min-width: 44px"]');
            
            testResults.mobile = (isMobile && touchFriendly) || !isMobile ? 'pass' : 'pending';
            
            document.getElementById('mobile-status').textContent = isMobile ? 
                (touchFriendly ? '‚úÖ Mobile optimized' : '‚ùå Not optimized') : 
                '‚ö†Ô∏è Test on mobile device';
            document.getElementById('mobile-status').className = `status ${testResults.mobile}`;
            
            updateSummary();
        }

        function updateSummary() {
            const results = Object.values(testResults);
            const passed = results.filter(r => r === 'pass').length;
            const failed = results.filter(r => r === 'fail').length;
            const pending = results.filter(r => r === 'pending').length;
            const total = results.length;
            
            const summary = document.getElementById('test-summary');
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Total Tests:</strong> ${total}
                    </div>
                    <div>
                        <strong class="pass">‚úÖ Passed:</strong> ${passed}
                    </div>
                    <div>
                        <strong class="fail">‚ùå Failed:</strong> ${failed}
                    </div>
                    <div>
                        <strong class="pending">‚ö†Ô∏è Pending:</strong> ${pending}
                    </div>
                    <div>
                        <strong>Success Rate:</strong> ${total > 0 ? Math.round((passed / total) * 100) : 0}%
                    </div>
                </div>
                ${total > 0 ? `
                <div style="margin-top: 15px; padding: 10px; background: ${failed === 0 ? '#D1FAE5' : '#FEE2E2'}; border-radius: 4px;">
                    <strong>${failed === 0 ? 'üéâ All automated tests passed!' : '‚ö†Ô∏è Some tests failed - check individual controls above.'}</strong>
                </div>
                ` : ''}
            `;
        }

        // Initialize tests when page loads
        window.addEventListener('load', initializeTests);
        
        // Handle window resize for mobile testing
        window.addEventListener('resize', () => {
            if (testResults.mobile !== undefined) {
                testMobileOptimization();
            }
        });

        console.log('üó∫Ô∏è Map Controls Test Suite loaded successfully');
    </script>
</body>
</html>