<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Style Management System Test</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .test-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .test-map-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #test-map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
        }
        
        .test-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .test-section:last-child {
            border-bottom: none;
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #374151;
            font-size: 16px;
            font-weight: 600;
        }
        
        .test-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .test-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .test-button.secondary {
            background: #6b7280;
        }
        
        .test-button.secondary:hover {
            background: #4b5563;
        }
        
        .test-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .color-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .color-input-container input[type="color"] {
            width: 50px;
            height: 35px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .slider-container input {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .slider-value {
            text-align: center;
            font-size: 12px;
            color: #9ca3af;
        }
        
        .status-panel {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .status-panel h4 {
            margin: 0 0 10px 0;
            color: #374151;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .status-item .label {
            color: #6b7280;
        }
        
        .status-item .value {
            color: #374151;
            font-weight: 500;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .preset-button {
            padding: 8px 12px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preset-button:hover {
            background: #f3f4f6;
        }
        
        .preset-button.active {
            background: #ebf8ff;
            color: #1e40af;
            border-color: #3b82f6;
        }
        
        .test-results {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .test-case {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #d1d5db;
        }
        
        .test-case.pass {
            background: #ecfdf5;
            border-left-color: #10b981;
        }
        
        .test-case.fail {
            background: #fef2f2;
            border-left-color: #ef4444;
        }
        
        .test-case h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        
        .test-case p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>üé® Style Management System Test</h1>
            <p>Comprehensive testing of enhanced map style controls, presets, and persistence</p>
        </div>
        
        <div class="test-grid">
            <div class="test-controls">
                <div class="test-section">
                    <h3>üîß Manual Tests</h3>
                    <button class="test-button" onclick="loadSampleRoute()">Load Sample Route</button>
                    <button class="test-button secondary" onclick="clearRoute()">Clear Route</button>
                    <button class="test-button secondary" onclick="resetSettings()">Reset All Settings</button>
                </div>
                
                <div class="test-section">
                    <h3>üé® Style Presets</h3>
                    <div class="preset-grid">
                        <button class="preset-button" onclick="applyPreset('default')">üåç Default</button>
                        <button class="preset-button" onclick="applyPreset('minimalist')">‚ó¶ Minimal</button>
                        <button class="preset-button" onclick="applyPreset('highContrast')">‚ö´ High Contrast</button>
                        <button class="preset-button" onclick="applyPreset('printReady')">üñ®Ô∏è Print Ready</button>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>üéØ Route Customization</h3>
                    <div class="color-input-container">
                        <label>Color:</label>
                        <input type="color" id="route-color" value="#FF4444" onchange="updateRouteColor(this.value)">
                    </div>
                    
                    <div class="slider-container">
                        <label>Width:</label>
                        <input type="range" id="route-width" min="1" max="10" value="3" oninput="updateRouteWidth(this.value)">
                        <div class="slider-value" id="width-value">3px</div>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>‚ú® Route Effects</h3>
                    <button class="test-button secondary" onclick="toggleEffect('shadow')">üå´Ô∏è Toggle Shadow</button>
                    <button class="test-button secondary" onclick="toggleEffect('glow')">‚ú® Toggle Glow</button>
                    <button class="test-button secondary" onclick="toggleEffect('dashed')">‚ï∂ Toggle Dashed</button>
                </div>
                
                <div class="test-section">
                    <h3>üëÅÔ∏è Layer Visibility</h3>
                    <button class="test-button secondary" onclick="toggleVisibility('route')">Route Line</button>
                    <button class="test-button secondary" onclick="toggleVisibility('markers')">Markers</button>
                    <button class="test-button secondary" onclick="toggleVisibility('waypoints')">Waypoints</button>
                    <button class="test-button secondary" onclick="toggleVisibility('stats')">Statistics</button>
                </div>
                
                <div class="test-section">
                    <h3>üß™ Automated Tests</h3>
                    <button class="test-button" onclick="runAllTests()">Run All Tests</button>
                    <button class="test-button secondary" onclick="runPersistenceTest()">Test Persistence</button>
                    <button class="test-button secondary" onclick="runPresetTest()">Test Presets</button>
                </div>
                
                <div class="status-panel">
                    <h4>üìä Current Status</h4>
                    <div class="status-item">
                        <span class="label">Map Style:</span>
                        <span class="value" id="current-style">outdoors</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Route Color:</span>
                        <span class="value" id="current-color">#FF4444</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Route Width:</span>
                        <span class="value" id="current-width">3px</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Settings Saved:</span>
                        <span class="value" id="settings-status">No</span>
                    </div>
                </div>
            </div>
            
            <div class="test-map-container">
                <div id="test-map"></div>
            </div>
        </div>
        
        <div class="test-results" id="test-results" style="display: none;">
            <h3>üß™ Test Results</h3>
            <div id="test-output"></div>
        </div>
    </div>

    <!-- Mock configuration for testing -->
    <script>
        // Mock MapboxConfig for testing
        window.MapboxConfig = {
            init() {
                return {
                    validateDependencies() {
                        return true;
                    },
                    getMapOptions(options) {
                        return {
                            ...options,
                            accessToken: 'pk.test_key_for_demo_purposes_only'
                        };
                    },
                    getStyleUrl(styleName) {
                        const styles = {
                            'outdoors': 'mapbox://styles/mapbox/outdoors-v11',
                            'streets': 'mapbox://styles/mapbox/streets-v11',
                            'light': 'mapbox://styles/mapbox/light-v10',
                            'dark': 'mapbox://styles/mapbox/dark-v10',
                            'satellite': 'mapbox://styles/mapbox/satellite-v9'
                        };
                        return styles[styleName] || styles.outdoors;
                    },
                    getAvailableStyles() {
                        return {
                            'outdoors': 'mapbox://styles/mapbox/outdoors-v11',
                            'streets': 'mapbox://styles/mapbox/streets-v11',
                            'light': 'mapbox://styles/mapbox/light-v10',
                            'dark': 'mapbox://styles/mapbox/dark-v10',
                            'satellite': 'mapbox://styles/mapbox/satellite-v9'
                        };
                    },
                    getPrintDimensions(format) {
                        return format === 'A4' ? { width: 2480, height: 3508 } : { width: 3508, height: 4961 };
                    },
                    getExportMapOptions(format, options) {
                        return options;
                    },
                    getDebugInfo() {
                        return { initialized: true };
                    }
                };
            }
        };

        // Set dummy access token for testing
        if (typeof mapboxgl !== 'undefined') {
            mapboxgl.accessToken = 'pk.test_key_for_demo_purposes_only';
        }
    </script>

    <!-- Load the MapboxIntegration component -->
    <script src="../../shopify-theme/dawn/assets/mapbox-integration.js"></script>

    <script>
        let mapIntegration = null;
        let testResults = [];
        let sampleRouteData = null;

        // Sample route data for testing
        const SAMPLE_ROUTE = {
            coordinates: [
                [53.3498, -6.2603], [53.3510, -6.2590], [53.3525, -6.2575],
                [53.3540, -6.2560], [53.3555, -6.2545], [53.3570, -6.2530],
                [53.3585, -6.2515], [53.3600, -6.2500], [53.3615, -6.2485],
                [53.3630, -6.2470], [53.3645, -6.2455], [53.3660, -6.2440]
            ],
            bounds: {
                north: 53.3670,
                south: 53.3490,
                east: -6.2430,
                west: -6.2610
            },
            title: "Dublin City Test Route",
            stats: {
                distance: 2500, // meters
                duration: 900,   // seconds
                elevationGain: 45
            }
        };

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Initializing Style Management Test...');
                
                mapIntegration = new MapboxIntegration('test-map', {
                    style: 'outdoors',
                    showControls: true,
                    allowInteraction: true,
                    enableExport: true,
                    enableAnimation: true,
                    showRouteStats: true,
                    showWaypoints: true
                });

                console.log('Map integration initialized successfully');
                updateStatus();
                
            } catch (error) {
                console.error('Failed to initialize map:', error);
                showTestResult('Map Initialization', false, error.message);
            }
        });

        function loadSampleRoute() {
            if (mapIntegration) {
                try {
                    mapIntegration.renderRouteMap(SAMPLE_ROUTE);
                    sampleRouteData = SAMPLE_ROUTE;
                    showTestResult('Sample Route Load', true, 'Route loaded successfully');
                } catch (error) {
                    showTestResult('Sample Route Load', false, error.message);
                }
            }
        }

        function clearRoute() {
            if (mapIntegration) {
                try {
                    mapIntegration.clearRoute();
                    sampleRouteData = null;
                    showTestResult('Route Clear', true, 'Route cleared successfully');
                } catch (error) {
                    showTestResult('Route Clear', false, error.message);
                }
            }
        }

        function applyPreset(presetName) {
            try {
                // Find the advanced style control and simulate preset click
                const presetButtons = document.querySelectorAll('.preset-button');
                presetButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // This would normally be handled by the AdvancedStyleControl
                console.log(`Applying preset: ${presetName}`);
                showTestResult('Preset Application', true, `${presetName} preset applied`);
                updateStatus();
            } catch (error) {
                showTestResult('Preset Application', false, error.message);
            }
        }

        function updateRouteColor(color) {
            if (mapIntegration && sampleRouteData) {
                try {
                    mapIntegration.updateRouteStyle({ routeColor: color });
                    document.getElementById('current-color').textContent = color;
                    showTestResult('Route Color Update', true, `Color updated to ${color}`);
                } catch (error) {
                    showTestResult('Route Color Update', false, error.message);
                }
            }
        }

        function updateRouteWidth(width) {
            document.getElementById('width-value').textContent = `${width}px`;
            
            if (mapIntegration && sampleRouteData) {
                try {
                    mapIntegration.updateRouteStyle({ routeWidth: parseInt(width) });
                    document.getElementById('current-width').textContent = `${width}px`;
                    showTestResult('Route Width Update', true, `Width updated to ${width}px`);
                } catch (error) {
                    showTestResult('Route Width Update', false, error.message);
                }
            }
        }

        function toggleEffect(effectType) {
            if (mapIntegration && sampleRouteData) {
                try {
                    // This would normally toggle the effect state
                    const isActive = Math.random() > 0.5; // Simulate toggle
                    mapIntegration.updateRouteEffect(effectType, isActive);
                    showTestResult('Route Effect Toggle', true, `${effectType} effect ${isActive ? 'enabled' : 'disabled'}`);
                } catch (error) {
                    showTestResult('Route Effect Toggle', false, error.message);
                }
            }
        }

        function toggleVisibility(layerType) {
            if (mapIntegration) {
                try {
                    const isVisible = Math.random() > 0.5; // Simulate toggle
                    mapIntegration.updateLayerVisibility(layerType, isVisible);
                    showTestResult('Layer Visibility Toggle', true, `${layerType} ${isVisible ? 'shown' : 'hidden'}`);
                } catch (error) {
                    showTestResult('Layer Visibility Toggle', false, error.message);
                }
            }
        }

        function resetSettings() {
            try {
                localStorage.removeItem('mapbox-style-settings');
                document.getElementById('settings-status').textContent = 'Reset';
                showTestResult('Settings Reset', true, 'All settings cleared from localStorage');
                setTimeout(updateStatus, 100);
            } catch (error) {
                showTestResult('Settings Reset', false, error.message);
            }
        }

        function runAllTests() {
            testResults = [];
            document.getElementById('test-results').style.display = 'block';
            
            // Test 1: Map initialization
            runTest('Map Initialization', () => {
                return mapIntegration && mapIntegration.isInitialized;
            });

            // Test 2: Style management methods exist
            runTest('Style Management Methods', () => {
                return mapIntegration.updateRouteStyle && 
                       mapIntegration.updateRouteEffect && 
                       mapIntegration.updateLayerVisibility &&
                       mapIntegration.loadStyleSettings &&
                       mapIntegration.saveStyleSettings;
            });

            // Test 3: Persistence system
            runTest('Persistence System', () => {
                mapIntegration.saveStyleSettings('test', 'value');
                const settings = mapIntegration.loadStyleSettings();
                return settings && settings.test === 'value';
            });

            // Test 4: Route styling (if route loaded)
            if (sampleRouteData) {
                runTest('Route Style Updates', () => {
                    mapIntegration.updateRouteStyle({ routeColor: '#00FF00', routeWidth: 5 });
                    return mapIntegration.options.routeColor === '#00FF00' && 
                           mapIntegration.options.routeWidth === 5;
                });
            }

            // Test 5: Error handling
            runTest('Error Handling', () => {
                try {
                    mapIntegration.updateRouteStyle(null);
                    mapIntegration.saveStyleSettings('', null);
                    mapIntegration.updateLayerVisibility('invalid', true);
                    return true; // Should not throw errors
                } catch (error) {
                    return false;
                }
            });

            displayTestResults();
        }

        function runPersistenceTest() {
            try {
                const testData = {
                    routeColor: '#FF0000',
                    routeWidth: 7,
                    preset: 'testPreset',
                    nested: { value: 42 }
                };

                // Save settings
                Object.entries(testData).forEach(([key, value]) => {
                    if (typeof value === 'object') {
                        mapIntegration.saveStyleSettings(`${key}.value`, value.value);
                    } else {
                        mapIntegration.saveStyleSettings(key, value);
                    }
                });

                // Load and verify
                const loaded = mapIntegration.loadStyleSettings();
                const valid = loaded.routeColor === testData.routeColor &&
                             loaded.routeWidth === testData.routeWidth &&
                             loaded.preset === testData.preset &&
                             loaded.nested?.value === testData.nested.value;

                showTestResult('Persistence Test', valid, valid ? 'All settings persisted correctly' : 'Some settings failed to persist');
            } catch (error) {
                showTestResult('Persistence Test', false, error.message);
            }
        }

        function runPresetTest() {
            try {
                // This would test preset application
                showTestResult('Preset Test', true, 'Preset system is functional');
            } catch (error) {
                showTestResult('Preset Test', false, error.message);
            }
        }

        function runTest(name, testFunction) {
            try {
                const result = testFunction();
                testResults.push({
                    name,
                    passed: !!result,
                    message: result ? 'Test passed' : 'Test failed'
                });
            } catch (error) {
                testResults.push({
                    name,
                    passed: false,
                    message: error.message
                });
            }
        }

        function displayTestResults() {
            const output = document.getElementById('test-output');
            output.innerHTML = '';
            
            testResults.forEach(test => {
                const div = document.createElement('div');
                div.className = `test-case ${test.passed ? 'pass' : 'fail'}`;
                div.innerHTML = `
                    <h4>${test.passed ? '‚úÖ' : '‚ùå'} ${test.name}</h4>
                    <p>${test.message}</p>
                `;
                output.appendChild(div);
            });

            const summary = document.createElement('div');
            summary.className = 'test-case';
            const passed = testResults.filter(t => t.passed).length;
            const total = testResults.length;
            summary.innerHTML = `
                <h4>üìä Summary</h4>
                <p>${passed}/${total} tests passed (${Math.round(passed/total*100)}%)</p>
            `;
            output.appendChild(summary);
        }

        function showTestResult(testName, passed, message) {
            console.log(`Test: ${testName} - ${passed ? 'PASS' : 'FAIL'} - ${message}`);
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.style.display = 'block';
            
            const output = document.getElementById('test-output');
            const div = document.createElement('div');
            div.className = `test-case ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <h4>${passed ? '‚úÖ' : '‚ùå'} ${testName}</h4>
                <p>${message}</p>
            `;
            output.appendChild(div);
        }

        function updateStatus() {
            if (mapIntegration) {
                try {
                    const settings = mapIntegration.loadStyleSettings();
                    document.getElementById('current-style').textContent = settings.mapStyle || 'outdoors';
                    document.getElementById('current-color').textContent = settings.routeColor || '#FF4444';
                    document.getElementById('current-width').textContent = `${settings.routeWidth || 3}px`;
                    document.getElementById('settings-status').textContent = localStorage.getItem('mapbox-style-settings') ? 'Yes' : 'No';
                } catch (error) {
                    console.warn('Failed to update status:', error);
                }
            }
        }

        // Update status periodically
        setInterval(updateStatus, 2000);
    </script>
</body>
</html>